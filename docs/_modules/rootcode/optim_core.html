

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rootcode.optim_core &mdash; ROOT 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> ROOT
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rst/intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/workflow.html">2. Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/interface_guide.html">3. Interface guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/sample_data_walkthrough.html">4. Sample data walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/examples.html">5. Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/root_source.html">6. ROOT UI code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst/release_notes.html">7. Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ROOT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>rootcode.optim_core</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rootcode.optim_core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Contains primary class types for optimization analyses.</span>

<span class="sd">These are:</span>

<span class="sd">* :class:`Data` which holds the tables giving objective/constraint scores for each potential decision.</span>
<span class="sd">* :class:`Problem` which holds a single optimization problem.</span>
<span class="sd">* :class:`Analysis` and subclasses, which hold a collection of problems that make up a trade-off curve or other analysis.</span>

<span class="sd">    * :class:`Single`</span>
<span class="sd">    * :class:`ConfigList`</span>
<span class="sd">    * :class:`NDimFrontier`</span>
<span class="sd">    * :class:`WeightTableIterator`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cvx</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">arith_parser</span> <span class="k">as</span> <span class="n">ap</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implemented analysis types are:</span>
<span class="sd">atype_to_class = {</span>
<span class="sd">    &#39;single&#39;: Single,</span>
<span class="sd">    &#39;frontier&#39;: Frontier,</span>
<span class="sd">    &#39;n_dim_frontier&#39;: NDimFrontier,</span>
<span class="sd">    &#39;weight_table_iter&#39;: WeightTableIterator,</span>
<span class="sd">    &#39;n_dim_outline&#39;: NDimFrontierOutline</span>
<span class="sd">}</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="NPFixedSeed"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.NPFixedSeed">[docs]</a><span class="k">class</span> <span class="nc">NPFixedSeed</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For use as a context manager for controllable rng. Ensures that numpys&#39;s rng is returned to</span>
<span class="sd">    original state outside of the calling context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>


<div class="viewcode-block" id="Data"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Data">[docs]</a><span class="k">class</span> <span class="nc">Data</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Holds data needed for optimization</span>

<span class="sd">        After initialization refer to ``data.factor_names`` and ``data.option_names``</span>
<span class="sd">        for the labels attached to each category. These are taken from file or column names depending</span>
<span class="sd">        on the files_by_factor argument.</span>

<span class="sd">        Specific data tables can be referenced by ``data[factor_name]``, similar to dictionary reference</span>
<span class="sd">        Columns for particular options can be referenced by ``data[factor_name, option_name]``</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Data.__init__"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Data.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">sdu_id_col</span><span class="p">,</span> <span class="n">data_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">baseline_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">files_by_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">file_glob_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            data_dir: directory to load data from.</span>
<span class="sd">            sdu_id_col: name of SDU key column</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            data_cols: names of columns to pull from csv files, default (None) pulls all</span>
<span class="sd">            baseline_file: optional name of baseline file to move to first position in option list</span>
<span class="sd">            file_list: list of files (only the basename) to load from data_dir.</span>
<span class="sd">            files_by_factor: if True, treats separate files as corresponding to factors with one column per option.</span>
<span class="sd">                Otherwise treats files as corresponding to options with one column per factor</span>
<span class="sd">            file_glob_str: if None, loads files in data_dir matching &#39;*.csv&#39;, otherwise will match given pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save the calling arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdu_id_col</span> <span class="o">=</span> <span class="n">sdu_id_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_cols</span> <span class="o">=</span> <span class="n">data_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_file</span> <span class="o">=</span> <span class="n">baseline_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">file_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_by_factor</span> <span class="o">=</span> <span class="n">files_by_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_glob_str</span> <span class="o">=</span> <span class="n">file_glob_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_seed</span> <span class="o">=</span> <span class="n">sample_seed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">option_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get the names of the files to load</span>
        <span class="k">if</span> <span class="n">file_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_glob_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;*.csv&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">file_glob_str</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">baseline_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">baseline_file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
            <span class="n">data_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">baseline_file</span><span class="p">)</span>
            <span class="n">data_files</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">baseline_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span> <span class="o">=</span> <span class="n">data_files</span>

        <span class="c1"># load the data files and ensure they&#39;re sorted by SDU_ID</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>

        <span class="c1"># determine which columns to keep (data columns + SDU_ID column)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">non_sdu_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">non_sdu_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">)</span>
            <span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">non_sdu_cols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_cols</span>
            <span class="n">non_sdu_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_cols</span>
        <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">data_files</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_keep</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: column </span><span class="si">{}</span><span class="s1"> not found in </span><span class="si">{}</span><span class="s1">. Filled with 0 values.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">col</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
                    <span class="p">))</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>

        <span class="c1"># (optional) sample the data (smaller datasets for testing)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>
            <span class="c1"># n_rows = len(dfs[0])</span>
            <span class="c1"># with FixedSeed(self.sample_seed):</span>
            <span class="c1">#     sample_rows = np.random.choice(n_rows, self.sample, replace=False)</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_seed</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>

        <span class="c1"># sort dfs by sdu_id_col</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sdu_id_col</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sdu_ids</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">sdu_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># transfer the data from data frames to numpy arrays</span>
        <span class="c1"># the arrays are aligned with one per factor, with rows for SDUs, cols for each option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_by_factor</span><span class="p">:</span>
            <span class="c1"># this case assumes one file per factor, with non-SDU columns corresponding to each option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_names</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">non_sdu_cols</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">factor</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_names</span><span class="p">):</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">non_sdu_cols</span><span class="p">])</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_parcels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this case assumes one file per option, with non-SDU columns corresponding to each factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_names</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">non_sdu_cols</span><span class="p">)</span>
            <span class="n">matshape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">non_sdu_cols</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matshape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
                    <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_parcels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_opts</span> <span class="o">=</span> <span class="n">matshape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">option_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">opt</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option_names</span><span class="p">)}</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># the case where we have two strings (factor, option)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_index</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> files from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_files</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>

<div class="viewcode-block" id="Data.factor_values_for_solution"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Data.factor_values_for_solution">[docs]</a>    <span class="k">def</span> <span class="nf">factor_values_for_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary containing the summed values for each factor </span>
<span class="sd">        in data. keys are factornames, values are the sums. </span>
<span class="sd">        </span>
<span class="sd">        Caller can subset which cols to return with varnames list.</span>

<span class="sd">        :param sol: real [0 - 1] valued array of size (n_parcels, n_opts) </span>
<span class="sd">        :param varnames: optional list of factors to evaluate</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">varnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_cols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factors</span> <span class="o">=</span> <span class="n">varnames</span>

        <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">sol</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div></div>


<span class="n">Constraint</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Constraint&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="Problem"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem">[docs]</a><span class="k">class</span> <span class="nc">Problem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># TODO: fixed_vals and excluded_vals have inconsistent approaches to x (integer vs multi-binary)</span>
    <span class="c1"># TODO: how to distinguish exclusive sets as == 1 vs &lt;= 1 (or to change the 1 value!)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The problem class. Represents a single optimization evaluation.</span>

<span class="sd">    problem_def should be a dict structured as follows</span>

<span class="sd">    * &#39;weights&#39;: {factorname: weight} for each factor &lt;- i.e. another dict</span>
<span class="sd">    * &#39;constraints&#39;: [ (factorname, type, value), ...] list of single-factor constraints</span>
<span class="sd">    * &#39;factor_by_option_constraints&#39;: [ (factorname, option, type, value), ... ] applies the constraint</span>
<span class="sd">        only to the listed option.</span>

<span class="sd">        deprecated: </span>
<span class="sd">            &#39;targets&#39;: {factorname: target} for each factor with a target</span>
<span class="sd">            &#39;target_types&#39;: {factorname: &#39;&lt;&#39;, &#39;&gt;&#39;, or &#39;=&#39; } (inequals will allow ==)</span>


<span class="sd">    optional problem args:</span>
<span class="sd">        &#39;fixed_vals&#39;: {index: value}: x_index will be constrained to value</span>
<span class="sd">        &#39;excluded_vals&#39; {index: list}: x_index_j will be set to zero for each</span>
<span class="sd">                                      j in list</span>
<span class="sd">        &#39;exclusive_choices&#39;: None, list, or list of lists. The values in the list should be the j-indices</span>
<span class="sd">            of the options to be made mutually-exclusive</span>
<span class="sd">            * None: default, assumes that all choices are mutually exclusive</span>
<span class="sd">            * list: only the options in the list are exclusive with each other. All options not in the</span>
<span class="sd">                list can be selected regardless of selection in the listed options, or the other</span>
<span class="sd">                non-listed options</span>
<span class="sd">            * list of lists: creates several sets of mutually exclusive options, but can choose one option</span>
<span class="sd">                from each set. Options not included in a list can be selected or not independent of </span>
<span class="sd">                selection in the mutually-exlusive sets.</span>
<span class="sd">        &#39;normalize_objectives&#39;: True or False (assumed False if arg not present)</span>
<span class="sd">            this will rescale all arguments to be between 0 and 1</span>
<span class="sd">            &#39;flatten_objectives&#39;: True or False (assumed False if arg not present)</span>
<span class="sd">            this replaces objective values with their relative rank</span>
<span class="sd">            NOTE: I think this might produce solutions that aren&#39;t actually</span>
<span class="sd">            on the frontier. </span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Problem.__init__"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">problem_def</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Problem creation function</span>
<span class="sd">        </span>
<span class="sd">        after the problem has been run, the results are attainable as:</span>

<span class="sd">        * :attr:`p.solution`: nsdus x nopts numpy array with values between 0 and 1</span>
<span class="sd">        * :attr:`p.objective_values`: {factor: value} summed scores for all factors</span>

<span class="sd">        :param data: a Data object</span>
<span class="sd">        :param problem_def: a dictionary describing the problem to solve</span>
<span class="sd">        :param solver: optional argument to specify the solver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_def</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># determine variable type</span>
        <span class="k">if</span> <span class="s1">&#39;use_linear_vars&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;use_linear_vars&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">=</span> <span class="s1">&#39;Linear&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;target_types&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;target_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">=</span> <span class="s1">&#39;Linear&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">=</span> <span class="s1">&#39;Boolean&#39;</span>

        <span class="c1"># construct list of Constraints</span>
        <span class="k">if</span> <span class="s1">&#39;constraints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid constraint&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.constraints: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">))</span>

        <span class="c1"># construct weights</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;Problem(</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, solver=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;problem_def&#39;</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Problem.solve"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds the MILP problem and calls a solver.</span>

<span class="sd">        Returns:</span>
<span class="sd">            solution (np.array): Optimized decision vector (matrix)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">factor_names</span>
        <span class="n">nparcels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n_parcels</span>
        <span class="n">nopts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n_opts</span>
        <span class="n">ndvs</span> <span class="o">=</span> <span class="n">nparcels</span> <span class="o">*</span> <span class="n">nopts</span>

        <span class="k">def</span> <span class="nf">xij_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="c1"># returns column index in G and A for given xij, where i is the parcel</span>
            <span class="c1"># unit, and j is the option.</span>
            <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nopts</span> <span class="o">+</span> <span class="n">j</span>

        <span class="c1"># Declare variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s1">&#39;Linear&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">NonNegative</span><span class="p">(</span><span class="n">ndvs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s1">&#39;Boolean&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">ndvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">ndvs</span><span class="p">)</span>

        <span class="c1"># CONSTRUCT OBJECTIVE FUNCTION</span>
        <span class="c1"># the objective is just a weighted sum of the different factors</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndvs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problem factors: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">factors</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;normalize_objectives&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;normalize_objectives&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;normalizing factor </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_factor_data</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying weight </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">fv</span>

        <span class="c1"># x has size (ndvs, 1), v has size (ndvs, ) - i.e. is 1-dimensional</span>
        <span class="c1"># doing v * x with these sizes will compute dot product.</span>
        <span class="n">objective</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

        <span class="c1"># CONSTRUCT CHOICE CONSTRAINTS</span>

        <span class="c1"># DEFINE EXCLUSIVE OPTION SETS</span>
        <span class="c1"># the default case is that all options are exclusive (first clause)</span>
        <span class="k">if</span> <span class="s1">&#39;exclusive_choices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default case: all choices are mutually exclusive</span>
            <span class="c1"># &#39;exclusive_choices&#39; not in self.problem_def or self.problem_def[&#39;exclusive_choices&#39;] is None</span>
            <span class="n">cm</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="n">nparcels</span><span class="p">,</span> <span class="n">nopts</span><span class="p">)</span>
            <span class="n">parcel_choice_constraint</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span> <span class="o">*</span> <span class="n">x</span> <span class="o">==</span> <span class="n">cv</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="c1"># case with no exclusive options</span>
            <span class="n">parcel_choice_constraint</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># case with just one exclusive set</span>
            <span class="n">cm</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="n">nparcels</span><span class="p">,</span> <span class="n">nopts</span><span class="p">,</span>
                                                        <span class="n">opt_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">])</span>
            <span class="n">parcel_choice_constraint</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span> <span class="o">*</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">cv</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># case with multiple exclusive sets</span>
            <span class="n">parcel_choice_constraint</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opt_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;exclusive_choices&#39;</span><span class="p">]:</span>
                <span class="n">cm</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="n">nparcels</span><span class="p">,</span> <span class="n">nopts</span><span class="p">,</span> <span class="n">opt_set</span><span class="o">=</span><span class="n">opt_set</span><span class="p">)</span>
                <span class="n">parcel_choice_constraint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span> <span class="o">*</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">cv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;invalid options for problem_def[&#39;exclusive_choices&#39;]&quot;</span><span class="p">)</span>

        <span class="c1"># FIXED VALUES CONSTRAINTS</span>
        <span class="c1"># these set x_ij = 1 so that choices can be locked in</span>
        <span class="c1"># &#39;fixed_vals&#39;: {index: value}: x_index will be constrained to value</span>
        <span class="k">if</span> <span class="s1">&#39;fixed_vals&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fixed_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;fixed_vals&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixed_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">fixed_val_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">xij_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fixed_vals</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="c1"># EXCLUDED VALUES CONSTRAINTS</span>
        <span class="c1"># these set values to zero so that they won&#39;t be chosen</span>
        <span class="c1"># &#39;excluded_vals&#39; {index: list}: x_index_j will be set to zero for each</span>
        <span class="c1">#                               j in list</span>

        <span class="k">if</span> <span class="s1">&#39;excluded_vals&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">excluded_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;excluded_vals&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">excluded_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">excluded_val_constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">excluded_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">excluded_val_constraints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">xij_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">])</span>

        <span class="c1"># ADD EXCLUDE CONSTRAINTS FOR 0 AREA ACTIVITIES</span>
        <span class="c1"># These are based on the &#39;exclude&#39; column that is automatically created by the</span>
        <span class="c1"># preprocessing step.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparcels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nopts</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exclude&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">excluded_val_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">xij_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># CONSTRUCT FACTOR CONSTRAINTS</span>
        <span class="n">factor_constraints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">factor_value</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">):</span>
                <span class="n">factor_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_value</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">):</span>
                <span class="n">factor_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_value</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_value</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;targets&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s1">&#39;replace &quot;targets and &quot;target_types&quot; with &quot;constraints&quot;&#39;</span><span class="p">,</span>
                                 <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="s1">&#39;optim_core.py&#39;</span><span class="p">,</span> <span class="mi">314</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">factor_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">x</span>
                <span class="n">factor_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;target_types&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">):</span>
                    <span class="n">factor_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_value</span> <span class="o">&lt;=</span> <span class="n">factor_target</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;target_types&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">):</span>
                    <span class="n">factor_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_value</span> <span class="o">&gt;=</span> <span class="n">factor_target</span><span class="p">)</span>

        <span class="c1"># COMPLEX CONSTRAINTS</span>
        <span class="c1"># TODO: figure out the right place to do different parts of this</span>
        <span class="n">fbo_constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;factor_by_option_constraints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">:</span>
            <span class="c1"># fbo constraints should have the form (factor, option, type, value)</span>
            <span class="c1"># they only apply the constraint sum(f*x) &gt;/&lt; value to xs for given option</span>
            <span class="k">for</span> <span class="n">fboc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_def</span><span class="p">[</span><span class="s1">&#39;factor_by_option_constraints&#39;</span><span class="p">]:</span>
                <span class="n">factor</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fboc</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding FBO constraint: </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">fboc</span><span class="p">))</span>
                <span class="n">opt_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">option_index</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">factor</span><span class="p">,</span> <span class="n">option</span><span class="p">]</span>
                <span class="n">lhs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">opt_index</span><span class="p">::</span><span class="n">nopts</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">):</span>
                    <span class="n">fbo_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">):</span>
                    <span class="n">fbo_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&gt;=</span>  <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fbo_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lhs</span> <span class="o">==</span>  <span class="n">value</span><span class="p">)</span>


        <span class="c1"># BUILD OPTIMIZATION PROBLEM</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">parcel_choice_constraint</span> <span class="o">+</span> <span class="n">fixed_val_constraints</span> <span class="o">+</span> \
                      <span class="n">excluded_val_constraints</span> <span class="o">+</span> <span class="n">factor_constraints</span> <span class="o">+</span> \
                      <span class="n">fbo_constraints</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>  <span class="c1"># solver=cvx.GLPK_MI</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status:&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimal value&quot;</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">variables</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nparcels</span><span class="p">,</span> <span class="n">nopts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">factor_values_for_solution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solved</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution total: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span></div>

<div class="viewcode-block" id="Problem.normalize_factor_data"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.normalize_factor_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">normalize_factor_data</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fv</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># this will be the case for the endpoints in the frontier runs</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">fv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="p">((</span><span class="n">fv</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fv</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fv</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">fv</span></div>

<div class="viewcode-block" id="Problem.single_choice_constraint_mats"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.single_choice_constraint_mats">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">single_choice_constraint_mats</span><span class="p">(</span><span class="n">nunits</span><span class="p">,</span> <span class="n">nopts</span><span class="p">,</span> <span class="n">opt_set</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts nunits integer variables to nunits*nopts binary variables.</span>
<span class="sd">        use case here is for choosing 1 out of nopts options for each unit</span>

<span class="sd">        :param nunits:</span>
<span class="sd">        :param nopts:</span>
<span class="sd">        :param opt_set: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">nunits</span> <span class="o">*</span> <span class="n">nopts</span>

        <span class="k">if</span> <span class="n">opt_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclusive_choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nopts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exclusive_choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nopts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">opt_set</span><span class="p">:</span>
                <span class="n">exclusive_choice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nunits</span><span class="p">,</span> <span class="n">nvars</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nunits</span><span class="p">):</span>
            <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">nopts</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">nopts</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">exclusive_choice</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nunits</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span></div>

<div class="viewcode-block" id="Problem.add_weight"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.add_weight">[docs]</a>    <span class="k">def</span> <span class="nf">add_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorname</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">factorname</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span></div>

<div class="viewcode-block" id="Problem.remove_weight"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.remove_weight">[docs]</a>    <span class="k">def</span> <span class="nf">remove_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">factorname</span><span class="p">)</span></div>

<div class="viewcode-block" id="Problem.add_constraint"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.add_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="c1"># TODO should this function just take list/tuples?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">factorname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span></div>

<div class="viewcode-block" id="Problem.remove_constraint"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.remove_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">remove_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="c1"># note for this, namedtuples and tuples will evaluate == if they have the same values in each position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="p">(</span><span class="n">factorname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Problem.solution_to_csv"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Problem.solution_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">solution_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_ids</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">table_cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">option_names</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">table_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">table_cols</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Analysis"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis">[docs]</a><span class="k">class</span> <span class="nc">Analysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent class for all analysis types.</span>


<span class="sd">    What are the functions/capabilities that all analyses need to have?</span>

<span class="sd">    #. run</span>
<span class="sd">    #. get item: analysis[i] returns ith point</span>
<span class="sd">    #. iterate through stored points</span>
<span class="sd">    #. save to reports (summary, full details, maps)</span>

<span class="sd">    This class assumes that all problems will be added to a list (self.problems), and that</span>
<span class="sd">    the problems have a problem.solve() method. Calling self.run() on the analysis will</span>
<span class="sd">    call solve() on all problems.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Analysis.__init__"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates empty :attr:`self.problems` list.</span>

<span class="sd">        :type data: :class:`.Data`</span>
<span class="sd">        :param data: contains problem data</span>

<span class="sd">        :type config: dict</span>
<span class="sd">        :param config: values to configure specific analysis type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problems</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">[</span><span class="n">position</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">)</span>

<div class="viewcode-block" id="Analysis.run"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calls :meth:`~.Problem.solve()` on all problems in `self.problems`</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div>

<div class="viewcode-block" id="Analysis.report"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_file</span><span class="p">,</span> <span class="n">report_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Analysis.problem_dict"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.problem_dict">[docs]</a>    <span class="k">def</span> <span class="nf">problem_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">problem</span></div>

<div class="viewcode-block" id="Analysis.save_decision_tables"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.save_decision_tables">[docs]</a>    <span class="k">def</span> <span class="nf">save_decision_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls :meth:`~.Problem.solution_to_csv` on all problems in :attr:`self.problems`. Files will be</span>
<span class="sd">        generated at :file:`folder/solution_id.csv`.</span>

<span class="sd">        :type folder: str</span>
<span class="sd">        :param folder: output folder (will be created if it does not exist)</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;solution_</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">solution_to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analysis.save_summary_table"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.save_summary_table">[docs]</a>    <span class="k">def</span> <span class="nf">save_summary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">add_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a table with summary stats (summed results) for each solution in the :class:`.Analysis`.</span>

<span class="sd">        :type folder: str</span>
<span class="sd">        :param folder: output folder (will be created if it does not exist)</span>

<span class="sd">        :type add_cols: dict</span>
<span class="sd">        :param add_cols: column names and data to add to output table</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;summary_table.csv&#39;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;point&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">factor_names</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">factor_values_for_solution</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">add_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analysis.summed_choices"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.summed_choices">[docs]</a>    <span class="k">def</span> <span class="nf">summed_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sums :math:`x_{pc}` for each parcel and choice across all solutions.</span>

<span class="sd">        :return: np.array (n_parcels, n_opts)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_parcels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n_parcels</span>
        <span class="n">n_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n_opts</span>
        <span class="n">choice_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_parcels</span><span class="p">,</span> <span class="n">n_opts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">:</span>
            <span class="n">choice_sum</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">solution</span>
        <span class="k">return</span> <span class="n">choice_sum</span></div>

<div class="viewcode-block" id="Analysis.save_summed_choices"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.save_summed_choices">[docs]</a>    <span class="k">def</span> <span class="nf">save_summed_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves results of :meth:`~Analysis.summed_choices` to a csv with option names as headers.</span>

<span class="sd">        The file will be saved to :file:`folder/summed_choices.csv`.</span>

<span class="sd">        :type folder: str</span>
<span class="sd">        :param folder: output folder (will be created if it does not exist)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        
        <span class="n">summed_choices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summed_choices</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_ids</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">table_cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sdu_id_col</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">option_names</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">summed_choices</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">table_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">table_cols</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;summed_choices.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analysis.factor_scores"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Analysis.factor_scores">[docs]</a>    <span class="k">def</span> <span class="nf">factor_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">objective_values</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">]</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_point_def_from_frontier_with_weight_mult</span><span class="p">(</span><span class="n">frontier_def</span><span class="p">,</span> <span class="n">weight_mult_dict</span><span class="p">):</span>
        <span class="n">point_def</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">frontier_def</span><span class="p">)</span>  <span class="c1"># need deepcopy to copy the weights dicts</span>
        <span class="c1"># just need to overwrite weights</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weight_mult_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">point_def</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="n">obj</span><span class="p">]</span> <span class="o">*=</span> <span class="n">w</span>
        <span class="k">return</span> <span class="n">point_def</span></div>


<div class="viewcode-block" id="Single"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Single">[docs]</a><span class="k">class</span> <span class="nc">Single</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analysis container for a single optimization run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Single.__init__"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Single.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            data: instance of :class:`.Data`</span>
<span class="sd">            config:</span>
<span class="sd">            solver:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Single</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>  <span class="c1"># copies config into self.config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.config: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span></div>

<div class="viewcode-block" id="Single.problem_dict"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.Single.problem_dict">[docs]</a>    <span class="k">def</span> <span class="nf">problem_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Single</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">problem_dict</span><span class="p">()</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">return</span> <span class="n">problem</span></div></div>


<div class="viewcode-block" id="ConfigList"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.ConfigList">[docs]</a><span class="k">class</span> <span class="nc">ConfigList</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper analysis for script-driven batching.</span>

<span class="sd">    Allows creation of analyses from a list of configuration dictionaries.</span>

<span class="sd">    e.g. iterating through constraint values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">config_list</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Problem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">))</span></div>


<div class="viewcode-block" id="NDimFrontier"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.NDimFrontier">[docs]</a><span class="k">class</span> <span class="nc">NDimFrontier</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Monte Carlo sampling of N-dimensional frontier.</span>

<span class="sd">    This class generates random uniformly distributed weight vectors and </span>
<span class="sd">    runs the optimization for each of these.</span>

<span class="sd">    config should be a dict structured as follows:</span>
<span class="sd">        &#39;npts&#39;: number of points to build in frontier</span>
<span class="sd">        &#39;objectives&#39;: [factornames]</span>
<span class="sd">        &#39;weights&#39;: {factornames}: +/- 1.0 for each factor to determine max or min goals</span>
<span class="sd">        &#39;constraints&#39;: [ (factorname, type, value), ... ]</span>
<span class="sd">        &#39;fixedvals&#39;: {index: value}: x_index will be constrained to value</span>
<span class="sd">        &#39;excludedvals&#39; {index: list}: x_index_j will be set to zero for each</span>
<span class="sd">                                      j in list</span>
<span class="sd">    deprecated:</span>
<span class="sd">        &#39;targets&#39;: {factornames}: target for each factor with a target</span>
<span class="sd">        &#39;targettypes&#39;: {factornames}: &#39;&lt;&#39;, &#39;&gt;&#39;, or &#39;=&#39; (inequals will allow ==)</span>


<span class="sd">    example of frontier_def coming from root_ui: </span>
<span class="sd">    {   </span>
<span class="sd">        &#39;analysis_type&#39;: u&#39;n_dim_frontier&#39;,</span>
<span class="sd">        &#39;flatten_objectives&#39;: False,</span>
<span class="sd">        &#39;normalize_objectives&#39;: True,</span>
<span class="sd">        &#39;npts&#39;: 15,</span>
<span class="sd">        &#39;objectives&#39;: [&#39;sed_hyd&#39;, &#39;phos_wetl&#39;, &#39;n_export&#39;],</span>
<span class="sd">        &#39;targets&#39;: {&#39;maskpixha&#39;: 20000.0},</span>
<span class="sd">        &#39;targettypes&#39;: {&#39;maskpixha&#39;: &#39;=&#39;},</span>
<span class="sd">        &#39;use_mp&#39;: False,</span>
<span class="sd">        &#39;weights&#39;: {&#39;n_export&#39;: -1.0, &#39;phos_wetl&#39;: -1.0, &#39;sed_hyd&#39;: -1.0}</span>
<span class="sd">    }</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NDimFrontier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobjs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_weight_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_vectors</span><span class="p">:</span>
            <span class="n">weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">wv</span><span class="p">)}</span>
            <span class="n">point_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_point_def_from_frontier_with_weight_mult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">weight_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding point with weights: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wv</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Problem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">point_def</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_weight_vectors</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndims</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param npts: </span>
<span class="sd">        :param ndims: </span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndims</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">ndims</span><span class="p">),</span> <span class="n">npts</span><span class="p">)</span>
        <span class="n">norm_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">norm_pts</span></div>


<div class="viewcode-block" id="WeightTableIterator"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.WeightTableIterator">[docs]</a><span class="k">class</span> <span class="nc">WeightTableIterator</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analysis with user-specifed weights for each contained problem.</span>

<span class="sd">    config should be a dict structured as follows:</span>
<span class="sd">    .. code:</span>
<span class="sd">    {</span>
<span class="sd">        &#39;npts&#39;: number of points to build in frontier</span>
<span class="sd">        &#39;objectives&#39;: [factornames]</span>
<span class="sd">        &#39;weights&#39;: {factornames}: +/- 1.0 for each factor to determine max or min goals</span>
<span class="sd">        &#39;constraints&#39;: [ (factorname, type, value), ... ]</span>
<span class="sd">        &#39;fixedvals&#39;: {index: value}: x_index will be constrained to value</span>
<span class="sd">        &#39;excludedvals&#39; {index: list}: x_index_j will be set to zero for each</span>
<span class="sd">                                      j in list</span>
<span class="sd">    deprecated:</span>
<span class="sd">        &#39;targets&#39;: {factornames}: target for each factor with a target</span>
<span class="sd">        &#39;targettypes&#39;: {factornames}: &#39;&lt;&#39;, &#39;&gt;&#39;, or &#39;=&#39; (inequals will allow ==)</span>
<span class="sd">    }</span>


<span class="sd">    example of frontier_def coming from root_ui:</span>
<span class="sd">    {</span>
<span class="sd">        &#39;analysis_type&#39;: u&#39;n_dim_frontier&#39;,</span>
<span class="sd">        &#39;flatten_objectives&#39;: False,</span>
<span class="sd">        &#39;normalize_objectives&#39;: True,</span>
<span class="sd">        &#39;npts&#39;: 15,</span>
<span class="sd">        &#39;objectives&#39;: [&#39;sed_hyd&#39;, &#39;phos_wetl&#39;, &#39;n_export&#39;],</span>
<span class="sd">        &#39;targets&#39;: {&#39;maskpixha&#39;: 20000.0},</span>
<span class="sd">        &#39;targettypes&#39;: {&#39;maskpixha&#39;: &#39;=&#39;},</span>
<span class="sd">        &#39;use_mp&#39;: False,</span>
<span class="sd">        &#39;weights&#39;: {&#39;n_export&#39;: -1.0, &#39;phos_wetl&#39;: -1.0, &#39;sed_hyd&#39;: -1.0}</span>
<span class="sd">    }</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="WeightTableIterator.__init__"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.WeightTableIterator.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`WeightTableIterator` requires that :attr:`config[&#39;weights&#39;]` contain the path</span>
<span class="sd">        to a .csv file with the appropriate sub-objective weights for each run to be</span>
<span class="sd">        performed.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: instance of :class:`.Data`</span>
<span class="sd">            config (dict):</span>
<span class="sd">            solver:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WeightTableIterator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="n">weight_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="n">weight_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">weight_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">weight_cols</span><span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding point with weights: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weight_dict</span><span class="p">))</span>
            <span class="n">point_def</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">point_def</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Problem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">point_def</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problems</span><span class="p">)</span></div></div>


<span class="c1"># class NDimFrontierOutline(Analysis):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     This class should internally hold n Frontier class objects, and be able</span>
<span class="c1">#     to iterate through all n.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, config):</span>
<span class="c1">#         super(NDimFrontierOutline, self).__init__(config)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class SimpleSortFrontier(Analysis):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     The simple sort frontier just ranks options by benefit/cost, and returns the desired number of points</span>
<span class="c1">#     along the curve constructed by selecting in decreasing benefit/cost order.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, data, config):</span>
<span class="c1">#         super(SimpleSortFrontier, self).__init__(config)</span>


<span class="n">atype_to_class</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;single&#39;</span><span class="p">:</span> <span class="n">Single</span><span class="p">,</span>
    <span class="s1">&#39;n_dim_frontier&#39;</span><span class="p">:</span> <span class="n">NDimFrontier</span><span class="p">,</span>
    <span class="s1">&#39;weight_table&#39;</span><span class="p">:</span> <span class="n">WeightTableIterator</span>
    <span class="c1"># &#39;n_dim_outline&#39;: NDimFrontierOutline</span>
<span class="p">}</span>


<div class="viewcode-block" id="available_analysis_types"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.available_analysis_types">[docs]</a><span class="k">def</span> <span class="nf">available_analysis_types</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">atype_to_class</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ensure_args_dict</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sdu_id_col&#39;</span><span class="p">])</span>

    <span class="n">atype</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;analysis_type&#39;</span><span class="p">]</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">atype_to_class</span><span class="p">[</span><span class="n">atype</span><span class="p">](</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">cvx</span><span class="o">.</span><span class="n">GUROBI</span><span class="p">)</span>

    <span class="n">analysis</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<div class="viewcode-block" id="ensure_args_dict"><a class="viewcode-back" href="../../rst/root_source.html#rootcode.optim_core.ensure_args_dict">[docs]</a><span class="k">def</span> <span class="nf">ensure_args_dict</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to accept args as a json file or dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (dict or path to json file):</span>

<span class="sd">    Returns: args as a dict</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">test_problem</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">test_manual_frontier</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">test_ndimfrontier</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">test_weight_table_iterator</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">test_files_by_factor</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">test_choice_constraint_mat</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">test_choice_constraint_mat</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Problem</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Problem</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Problem</span><span class="o">.</span><span class="n">single_choice_constraint_mats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

    <span class="n">problem_def</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;objectives&#39;: [&#39;N_LOADING_REL&#39;, &#39;S_LOADING_REL&#39;],</span>
        <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N_LOADING_REL&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;S_LOADING_REL&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
        <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;AG_PROFIT_REL&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000000</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;N_LOADING_REL&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">)],</span>
        <span class="s1">&#39;npts&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;use_linear_vars&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;normalize_objectives&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_problem</span><span class="p">,</span> <span class="n">test_ndimfrontier</span><span class="p">,</span>
            <span class="n">test_manual_frontier</span><span class="p">,</span> <span class="n">test_weight_table_iterator</span><span class="p">]):</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;/Users/hawt0010/Projects/ROOT/root_source/sample_data/multi_bmp&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="s1">&#39;HRU&#39;</span><span class="p">,</span>
                    <span class="n">data_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;N_LOADING_REL&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;P_LOADING_REL&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;S_LOADING_REL&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;AG_PROFIT_REL&#39;</span><span class="p">])</span>
        <span class="n">n_parcels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">n_parcels</span>
        <span class="n">n_opts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">n_opts</span>

    <span class="k">if</span> <span class="n">test_data</span><span class="p">:</span>
        <span class="n">sample_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">n_parcels</span><span class="p">,</span> <span class="n">n_opts</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">factor_values_for_solution</span><span class="p">(</span><span class="n">sample_sol</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">test_problem</span><span class="p">:</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">problem_def</span><span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">GUROBI</span>
        <span class="n">opt_sol</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">objective_values</span><span class="p">)</span>
        <span class="n">prob</span><span class="o">.</span><span class="n">solution_to_csv</span><span class="p">(</span><span class="s1">&#39;test_sol.csv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_manual_frontier</span><span class="p">:</span>
        <span class="n">manual_problem_def</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;analysis_type&#39;</span><span class="p">:</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span>
            <span class="s1">&#39;objectives&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;N_LOADING_REL&#39;</span><span class="p">,</span> <span class="s1">&#39;S_LOADING_REL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N_LOADING_REL&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;S_LOADING_REL&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
            <span class="s1">&#39;use_linear_vars&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;normalize_objectives&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
        <span class="n">prof_vals</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">3000000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2000000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1000000.0</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Problem</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">manual_problem_def</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">prof_vals</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">prof_vals</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;AG_PROFIT_REL&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">objective_values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_ndimfrontier</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;/Users/hawt0010/Projects/ROOT/root_source/sample_output/ndf&quot;</span>
        <span class="n">ndf</span> <span class="o">=</span> <span class="n">NDimFrontier</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">problem_def</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">cvx</span><span class="o">.</span><span class="n">GUROBI</span><span class="p">)</span>
        <span class="n">ndf</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ndf</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ndf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">objective_values</span><span class="p">)</span>
        <span class="n">ndf</span><span class="o">.</span><span class="n">save_decision_tables</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="n">ndf</span><span class="o">.</span><span class="n">save_summary_table</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="n">ndf</span><span class="o">.</span><span class="n">save_summed_choices</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_weight_table_iterator</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="s2">&quot;/Users/hawt0010/Projects/ROOT/root_source/sample_output/wti&quot;</span>
        <span class="n">pdef</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_def</span><span class="p">)</span>
        <span class="n">pdef</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/Users/hawt0010/Projects/ROOT/root_source/sample_data/multi_bmp_weight_table.csv&quot;</span>
        <span class="n">wti</span> <span class="o">=</span> <span class="n">WeightTableIterator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pdef</span><span class="p">)</span>
        <span class="n">wti</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">wti</span><span class="o">.</span><span class="n">save_summary_table</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="n">wti</span><span class="o">.</span><span class="n">save_summed_choices</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="n">wti</span><span class="o">.</span><span class="n">save_decision_tables</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">test_files_by_factor</span><span class="p">:</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="s2">&quot;/Users/hawt0010/Projects/ROOT/root_source/sample_data/files_by_factor&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="s1">&#39;SDU&#39;</span><span class="p">,</span> <span class="n">files_by_factor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data.n_parcels: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">n_parcels</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data.n_opts: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">n_opts</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data.option_names: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">option_names</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data.factor_names: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">factor_names</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018, Peter Hawthorne

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>